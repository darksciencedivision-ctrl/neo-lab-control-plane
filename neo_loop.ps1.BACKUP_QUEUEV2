# ============================================================
# NEO LOOP — NEO-LAB COMMERCIAL ASSISTANT + TRUE MULTI-LINE IPC + REPORT MODE
# PowerShell: 5.1 + StrictMode safe
#
# New:
#   - TRUE multi-line IPC: reads neo_queue.txt as -Raw (entire file)
#   - /reportmode on|off|status (persisted in conversation_state.json)
#   - Report Writer Mode contract (single-response, multi-page deliverables)
#   - StrictMode-safe state migration (adds missing properties via Add-Member)
#
# Preserves:
#   - Deterministic routing + fail-closed behavior
#   - Memory isolation per intent
#   - Safe optional property access (images)
# ============================================================

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

$ROOT = Get-Location
$CONFIG_DIR    = Join-Path $ROOT "config"
$QUEUE_DIR     = Join-Path $ROOT "queue"
$QUEUE_FILE    = Join-Path $QUEUE_DIR "neo_queue.txt"
$RESPONSE_FILE = Join-Path $QUEUE_DIR "neo_response.txt"

# ---- CONFIG FILES ----
$PERSONA_FILE = Join-Path $CONFIG_DIR "persona_lab_assistant.json"
$STATE_FILE   = Join-Path $QUEUE_DIR  "conversation_state.json"
$PREFS_FILE   = Join-Path $QUEUE_DIR  "user_preferences.json"

# ---- OLLAMA ----
$OLLAMA_BASE = "http://127.0.0.1:11434"
$CHAT_URL    = "$OLLAMA_BASE/api/chat"
$TAGS_URL    = "$OLLAMA_BASE/api/tags"

# ---- MODELS ----
$MODEL_CHAT     = "dolphin-llama3:latest"
$MODEL_CODE     = "deepseek-coder-v2:latest"
$MODEL_ANALYSIS = "deepseek-r1:latest"
$MODEL_VISION   = "qwen2.5-vl:7b"

# ---- FEATURES ----
$MEMORY_ENABLED   = $true
$MEMORY_MAX_TURNS = 6
$VISION_ENABLED   = $true

Write-Host "=== NEO LOOP STARTING (NEO-LAB + RAW IPC + REPORT MODE) ===" -ForegroundColor Cyan

# ------------------------------------------------------------
# Utilities
# ------------------------------------------------------------
function Ensure-Files {
    if (-not (Test-Path $CONFIG_DIR))    { New-Item -ItemType Directory -Path $CONFIG_DIR | Out-Null }
    if (-not (Test-Path $QUEUE_DIR))     { New-Item -ItemType Directory -Path $QUEUE_DIR | Out-Null }
    if (-not (Test-Path $QUEUE_FILE))    { New-Item -ItemType File -Path $QUEUE_FILE | Out-Null }
    if (-not (Test-Path $RESPONSE_FILE)) { New-Item -ItemType File -Path $RESPONSE_FILE | Out-Null }
}

function Read-JsonFileOrNull([string]$path) {
    if (-not (Test-Path $path)) { return $null }
    try { return (Get-Content $path -Raw) | ConvertFrom-Json } catch { return $null }
}

function Write-JsonFile([string]$path, $obj) {
    try {
        $obj | ConvertTo-Json -Depth 24 | Set-Content $path -Encoding UTF8
        return $true
    } catch { return $false }
}

function Now-UtcIso {
    return ([DateTime]::UtcNow.ToString("yyyy-MM-ddTHH:mm:ssZ"))
}

function Write-Response([string]$Text) {
    $stamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Set-Content $RESPONSE_FILE "[NEO @ $stamp] $Text" -Encoding UTF8
}

# ------------------------------------------------------------
# TRUE MULTI-LINE QUEUE READ (RAW)
# ------------------------------------------------------------
function Read-QueueRawOnce {
    $raw = ""
    try {
        $raw = Get-Content $QUEUE_FILE -Raw -ErrorAction SilentlyContinue
    } catch {
        $raw = ""
    }

    if (-not $raw) { return $null }

    $msg = $raw.Trim()
    if (-not $msg) { return $null }

    # Clear queue AFTER successful read
    try { Clear-Content $QUEUE_FILE -ErrorAction SilentlyContinue } catch { }

    return [string]$msg
}

# ------------------------------------------------------------
# Ollama helpers
# ------------------------------------------------------------
function Get-OllamaModelNames {
    try {
        $r = Invoke-RestMethod -Uri $TAGS_URL -Method GET -TimeoutSec 10
        return @($r.models | ForEach-Object { $_.name })
    } catch { return @() }
}

function Has-Model($name, $all) {
    return ($all -contains $name)
}

function Invoke-Chat($model, $messages) {
    $body = @{
        model    = $model
        stream   = $false
        messages = $messages
    } | ConvertTo-Json -Depth 12

    try {
        $r = Invoke-RestMethod -Uri $CHAT_URL -Method POST -ContentType "application/json" -Body $body -TimeoutSec 600
        return $r.message.content
    } catch { return "" }
}

# ------------------------------------------------------------
# Memory
# ------------------------------------------------------------
function Memory-Path($intent) {
    Join-Path $QUEUE_DIR ("memory_{0}.json" -f $intent)
}

function Load-Memory($intent) {
    $path = Memory-Path $intent
    if (-not (Test-Path $path)) { return @() }
    try {
        $o = (Get-Content $path -Raw) | ConvertFrom-Json
        return @($o.messages)
    } catch { return @() }
}

function Save-Memory($intent, $messages) {
    $max = $MEMORY_MAX_TURNS * 2
    $arr = @($messages)
    if ($arr.Count -gt $max) { $arr = $arr[-$max..-1] }
    @{ messages = $arr } | ConvertTo-Json -Depth 10 | Set-Content (Memory-Path $intent) -Encoding UTF8
}

function Clear-Memory($which) {
    if ($which -eq "all") {
        foreach ($p in @("chat","code","analysis","vision")) {
            $mp = Memory-Path $p
            if (Test-Path $mp) { Remove-Item $mp -Force -ErrorAction SilentlyContinue }
        }
        return
    }
    if (@("chat","code","analysis","vision") -contains $which) {
        $mp = Memory-Path $which
        if (Test-Path $mp) { Remove-Item $mp -Force -ErrorAction SilentlyContinue }
    }
}

# ------------------------------------------------------------
# Intent router
# ------------------------------------------------------------
function Classify($t) {
    $l = $t.ToLower()

    if ($l.StartsWith("/vision"))   { return "vision" }
    if ($l.StartsWith("/code"))     { return "code" }
    if ($l.StartsWith("/analysis")) { return "analysis" }
    return "chat"
}

# ------------------------------------------------------------
# Persona + State + Contract Builders
# ------------------------------------------------------------
function Get-PersonaText($personaObj) {
    if (-not $personaObj) { return "" }

    $name = ""
    if ($personaObj.PSObject.Properties.Name -contains "display_name") { $name = [string]$personaObj.display_name }

    $tone = ""
    if ($personaObj.PSObject.Properties.Name -contains "tone") { $tone = [string]$personaObj.tone }

    $txt = ""
    if ($name) { $txt += ("Persona: {0}`n" -f $name) }
    if ($tone) { $txt += ("Tone: {0}`n" -f $tone) }

    return $txt.Trim()
}

function Ensure-StateObject($stateObj) {
    # StrictMode-safe schema migration: add missing props via Add-Member
    if (-not $stateObj) {
        $stateObj = [pscustomobject]@{}
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "assistant_mode")) {
        $stateObj | Add-Member -NotePropertyName "assistant_mode" -NotePropertyValue "lab"
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "report_mode")) {
        $stateObj | Add-Member -NotePropertyName "report_mode" -NotePropertyValue "off"
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "current_objective")) {
        $stateObj | Add-Member -NotePropertyName "current_objective" -NotePropertyValue "Unset"
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "current_context")) {
        $stateObj | Add-Member -NotePropertyName "current_context" -NotePropertyValue "Unset"
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "current_workspace")) {
        $stateObj | Add-Member -NotePropertyName "current_workspace" -NotePropertyValue ([string]$ROOT)
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "interaction")) {
        $stateObj | Add-Member -NotePropertyName "interaction" -NotePropertyValue ([pscustomobject]@{})
    }

    if (-not ($stateObj.interaction.PSObject.Properties.Name -contains "verbosity")) {
        $stateObj.interaction | Add-Member -NotePropertyName "verbosity" -NotePropertyValue "normal"
    }

    if (-not ($stateObj.interaction.PSObject.Properties.Name -contains "tone")) {
        $stateObj.interaction | Add-Member -NotePropertyName "tone" -NotePropertyValue "technical"
    }

    if (-not ($stateObj.interaction.PSObject.Properties.Name -contains "output_mode")) {
        $stateObj.interaction | Add-Member -NotePropertyName "output_mode" -NotePropertyValue "copy_paste"
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "assumptions")) {
        $stateObj | Add-Member -NotePropertyName "assumptions" -NotePropertyValue ([pscustomobject]@{})
    }

    if (-not ($stateObj.assumptions.PSObject.Properties.Name -contains "os")) {
        $stateObj.assumptions | Add-Member -NotePropertyName "os" -NotePropertyValue "Windows"
    }

    if (-not ($stateObj.assumptions.PSObject.Properties.Name -contains "shell")) {
        $stateObj.assumptions | Add-Member -NotePropertyName "shell" -NotePropertyValue "PowerShell 5.1"
    }

    if (-not ($stateObj.assumptions.PSObject.Properties.Name -contains "ollama_host")) {
        $stateObj.assumptions | Add-Member -NotePropertyName "ollama_host" -NotePropertyValue $OLLAMA_BASE
    }

    if (-not ($stateObj.PSObject.Properties.Name -contains "last_updated_utc")) {
        $stateObj | Add-Member -NotePropertyName "last_updated_utc" -NotePropertyValue (Now-UtcIso)
    }

    return $stateObj
}

function Get-StateSummaryText($stateObj) {
    $s = @()
    $s += ("Mode: {0}" -f [string]$stateObj.assistant_mode)
    $s += ("ReportMode: {0}" -f [string]$stateObj.report_mode)
    $s += ("Objective: {0}" -f [string]$stateObj.current_objective)
    $s += ("Context: {0}" -f [string]$stateObj.current_context)
    $s += ("Workspace: {0}" -f [string]$stateObj.current_workspace)

    $v = [string]$stateObj.interaction.verbosity
    $t = [string]$stateObj.interaction.tone
    $o = [string]$stateObj.interaction.output_mode

    $s += ("Style: verbosity={0}, tone={1}, output={2}" -f $v, $t, $o)
    return ($s -join "`n")
}

function Build-LabContract($personaObj, $stateObj) {
    $base = @"
You are NEO-LAB: a commercial-grade engineering lab assistant operating inside a deterministic local control plane.
You do not have autonomy. You respond only to user requests.

Operating contract:
- Be calm, technical, and helpful.
- Start each response with a one-line: Objective: ...
- Then use only the sections needed: What's happening, Recommended plan, Steps, Verification, If stuck.
- Prefer copy/paste blocks for commands and full-file outputs when requested.
- If a step is destructive, label it clearly and offer a safer alternative first.
- Do not claim emotions, consciousness, or independent intent.
- Keep the user as root authority.
"@

    $personaTxt = Get-PersonaText $personaObj
    $stateTxt = "Current state:`n" + (Get-StateSummaryText $stateObj)

    $contract = $base.Trim()
    if ($personaTxt) { $contract += "`n`n" + $personaTxt }
    $contract += "`n`n" + $stateTxt
    return $contract.Trim()
}

function Build-ReportContract($personaObj, $stateObj) {
    $lab = Build-LabContract $personaObj $stateObj

    $report = @"
REPORT WRITER MODE (single-response deliverable):
- Produce ONE single complete response only. Do not ask questions.
- The response must be self-contained and multi-page in depth if needed.
- Use a professional report structure.

Required sections:
1) Executive Summary
2) Scope & Assumptions
3) Core Analysis (use subsections as needed)
4) Methods / Models / Math (if relevant)
5) Implementation (commands/code) (if relevant)
6) Risks, Limitations, and Verification Checklist
7) References / Source Guidance (when relevant)

Constraints:
- Laws/regulations: general info only; "not legal advice"; advise verifying with official sources.
- Finance: general info only; "not financial advice".
- If uncertain: state assumptions explicitly, then proceed.
- Keep formatting clean: headings, bullets, numbered steps, code blocks.
"@

    return ($lab + "`n`n" + $report).Trim()
}

# ------------------------------------------------------------
# Command Parser / Handler
# ------------------------------------------------------------
function Parse-Command($t) {
    $line = ($t.Trim())
    if (-not $line.StartsWith("/")) { return $null }

    $cmd = ""
    $arg = ""

    $spaceIndex = $line.IndexOf(" ")
    if ($spaceIndex -gt 0) {
        $cmd = $line.Substring(0, $spaceIndex).ToLower()
        $arg = $line.Substring($spaceIndex + 1).Trim()
    } else {
        $cmd = $line.ToLower()
        $arg = ""
    }

    return @{ cmd = $cmd; arg = $arg }
}

function Apply-Command($cmdObj, $stateObj) {
    $stateObj = Ensure-StateObject $stateObj

    $cmd = [string]$cmdObj.cmd
    $arg = [string]$cmdObj.arg

    if ($cmd -eq "/objective") {
        if (-not $arg) { return @{ handled=$true; response=("Objective: Show objective`n{0}" -f [string]$stateObj.current_objective); state=$stateObj } }
        $stateObj.current_objective = $arg
        $stateObj.last_updated_utc = Now-UtcIso
        return @{ handled=$true; response=("Objective: Set objective`nSet objective to: {0}" -f $arg); state=$stateObj }
    }

    if ($cmd -eq "/context") {
        if (-not $arg) { return @{ handled=$true; response=("Objective: Show context`n{0}" -f [string]$stateObj.current_context); state=$stateObj } }
        $stateObj.current_context = $arg
        $stateObj.last_updated_utc = Now-UtcIso
        return @{ handled=$true; response=("Objective: Set context`nSet context to: {0}" -f $arg); state=$stateObj }
    }

    if ($cmd -eq "/mode") {
        $v = $arg.ToLower()
        if (-not $v) { $v = "lab" }
        if (@("lab","strict","chat") -notcontains $v) {
            return @{ handled=$true; response="Objective: Set mode`nInvalid mode. Use: /mode lab | /mode strict | /mode chat"; state=$stateObj }
        }
        $stateObj.assistant_mode = $v
        $stateObj.last_updated_utc = Now-UtcIso
        return @{ handled=$true; response=("Objective: Set mode`nMode set to: {0}" -f $v); state=$stateObj }
    }

    if ($cmd -eq "/verbosity") {
        $v = $arg.ToLower()
        if (-not $v) { $v = "normal" }
        if (@("low","normal","high") -notcontains $v) {
            return @{ handled=$true; response="Objective: Set verbosity`nInvalid verbosity. Use: /verbosity low | normal | high"; state=$stateObj }
        }
        $stateObj.interaction.verbosity = $v
        $stateObj.last_updated_utc = Now-UtcIso
        return @{ handled=$true; response=("Objective: Set verbosity`nVerbosity set to: {0}" -f $v); state=$stateObj }
    }

    if ($cmd -eq "/tone") {
        $v = $arg.ToLower()
        if (-not $v) { $v = "technical" }
        if (@("technical","friendly","blunt") -notcontains $v) {
            return @{ handled=$true; response="Objective: Set tone`nInvalid tone. Use: /tone technical | friendly | blunt"; state=$stateObj }
        }
        $stateObj.interaction.tone = $v
        $stateObj.last_updated_utc = Now-UtcIso
        return @{ handled=$true; response=("Objective: Set tone`nTone set to: {0}" -f $v); state=$stateObj }
    }

    if ($cmd -eq "/status") {
        $summary = Get-StateSummaryText $stateObj
        return @{ handled=$true; response=("Objective: Status`n{0}" -f $summary); state=$stateObj }
    }

    if ($cmd -eq "/memclear") {
        $which = $arg.ToLower()
        if (-not $which) { $which = "all" }
        if (@("chat","code","analysis","vision","all") -notcontains $which) {
            return @{ handled=$true; response="Objective: Clear memory`nInvalid target. Use: /memclear chat|code|analysis|vision|all"; state=$stateObj }
        }
        Clear-Memory $which
        return @{ handled=$true; response=("Objective: Clear memory`nCleared memory: {0}" -f $which); state=$stateObj }
    }

    if ($cmd -eq "/reportmode") {
        $v = $arg.ToLower()
        if (-not $v) { $v = "status" }

        if ($v -eq "status") {
            return @{ handled=$true; response=("Objective: Report mode status`nReportMode is: {0}" -f [string]$stateObj.report_mode); state=$stateObj }
        }

        if (@("on","off") -notcontains $v) {
            return @{ handled=$true; response="Objective: Set report mode`nInvalid. Use: /reportmode on | /reportmode off | /reportmode status"; state=$stateObj }
        }

        $stateObj.report_mode = $v
        $stateObj.last_updated_utc = Now-UtcIso
        return @{ handled=$true; response=("Objective: Set report mode`nReportMode set to: {0}" -f $v); state=$stateObj }
    }

    return @{ handled=$true; response="Objective: Command help`nSupported: /objective /context /mode /verbosity /tone /status /memclear /reportmode"; state=$stateObj }
}

# ------------------------------------------------------------
# Report Mode Detection
# ------------------------------------------------------------
function Is-ReportRequest($msg, $stateObj) {
    $l = $msg.ToLower()

    if ($l.StartsWith("/report")) { return $true }
    if ($l.Contains("[neo_output_mode:report]")) { return $true }

    if ($stateObj -and ($stateObj.PSObject.Properties.Name -contains "report_mode")) {
        if ([string]$stateObj.report_mode -eq "on") { return $true }
    }

    return $false
}

# ------------------------------------------------------------
# MAIN LOOP
# ------------------------------------------------------------
Ensure-Files

while ($true) {
    $ALL = Get-OllamaModelNames
    Write-Host ("NEO heartbeat @ {0}" -f (Get-Date)) -ForegroundColor DarkGreen

    $msg = Read-QueueRawOnce
    if (-not $msg) { Start-Sleep -Milliseconds 200; continue }

    $personaObj = Read-JsonFileOrNull $PERSONA_FILE
    $stateObj   = Read-JsonFileOrNull $STATE_FILE
    $prefsObj   = Read-JsonFileOrNull $PREFS_FILE

    $stateObj = Ensure-StateObject $stateObj

    # Commands first (only if the entire message begins with /command)
    $cmdObj = Parse-Command $msg
    if ($cmdObj) {
        $result = Apply-Command $cmdObj $stateObj
        $updatedState = $result.state
        if ($updatedState) { Write-JsonFile $STATE_FILE $updatedState | Out-Null }
        Write-Response ([string]$result.response)
        Start-Sleep -Milliseconds 120
        continue
    }

    $intent = Classify $msg

    # Choose model (fail-closed)
    $model = $MODEL_CHAT
    if ($intent -eq "code"     -and (Has-Model $MODEL_CODE     $ALL)) { $model = $MODEL_CODE }
    if ($intent -eq "analysis" -and (Has-Model $MODEL_ANALYSIS $ALL)) { $model = $MODEL_ANALYSIS }
    if ($intent -eq "vision"   -and (Has-Model $MODEL_VISION   $ALL)) { $model = $MODEL_VISION }

    $reportRequested = Is-ReportRequest $msg $stateObj

    Write-Host ("ROUTE: {0} → {1} (Report={2})" -f $intent, $model, $reportRequested) -ForegroundColor Cyan

    $mode = [string]$stateObj.assistant_mode
    $systemContract = "You are NEO."

    if ($mode -eq "lab" -or $mode -eq "strict") {
        if ($reportRequested) {
            $systemContract = Build-ReportContract $personaObj $stateObj
        } else {
            $systemContract = Build-LabContract $personaObj $stateObj
        }

        if ($mode -eq "strict" -and -not $reportRequested) {
            $systemContract += "`n`nStrict mode addendum:`n- Keep answers short.`n- Ask at most ONE clarifying question if required, otherwise provide A/B options.`n- No speculation."
        }
    }

    $messages = @(@{ role="system"; content=$systemContract })

    foreach ($m in @(Load-Memory $intent)) {
        if ($m.PSObject.Properties.Name -contains "images") {
            $messages += @{ role=$m.role; content=$m.content; images=$m.images }
        } else {
            $messages += @{ role=$m.role; content=$m.content }
        }
    }

    # If user uses /report prefix, strip it so the prompt is clean while report mode stays active
    $userContent = $msg
    if ($msg.ToLower().StartsWith("/report")) {
        $userContent = $msg.Substring(7).Trim()
        if (-not $userContent) { $userContent = "Write a report on the requested topic." }
    }

    $messages += @{ role="user"; content=$userContent }

    $draft = Invoke-Chat $model $messages

    # fail-closed fallback to chat model if empty
    if (-not $draft) {
        $fallbackMsgs = @(
            @{ role="system"; content=$systemContract },
            @{ role="user"; content=$userContent }
        )
        $draft = Invoke-Chat $MODEL_CHAT $fallbackMsgs
    }

    if (-not $draft) {
        $draft = "Objective: Respond`nI didn't get a response from the model. Check Ollama status and try again."
    }

    if ($MEMORY_ENABLED) {
        $mem = @(Load-Memory $intent)
        $mem += @{ role="user"; content=$msg }
        $mem += @{ role="assistant"; content=$draft }
        Save-Memory $intent $mem
    }

    Write-Response $draft
    Start-Sleep -Milliseconds 150
}
